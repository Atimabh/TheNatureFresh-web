<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <%- include ("partials/head.ejs") %>

    <script>
        var prods = '<%- JSON.stringify(products) %>';
        var test = JSON.parse(prods)
        var cart = {
            products:[],
            itemCount:0
        }
        var ucart = JSON.parse('<%- JSON.stringify(usercart) %>')
        var cart = ucart;
        
        const setPage = () =>{
            if(cart.itemCount != '0'){

                document.getElementById('checkoutBtnFab').style.display = 'block';
            } else {
                document.getElementById('checkoutBtnFab').style.display = 'none';
            }

            cart.products.forEach(item=>{
            var index = 0
            test.forEach(prod=>{
                if(item.id === prod.id)
                document.getElementById(index).innerHTML=item.qty_purchased
                else
                    index++;
            })
        })
        }
        const gotoCart = () =>{
            if(cart.itemCount!=0){
                $.post('/cart', {cart:cart}, function(response){ 
                    window.location.replace("/cart") 
                });
            }
            else{
                alert("Select some items before proceeding");
            }
            
        }
        const addProduct = index => {
            // console.log(test[index])
            const i = cart.products.findIndex( item => item.id === test[index].id)
            if(i !== -1){ //if item exists
                if(cart.products[i].qty_purchased<cart.products[i].qty_available){
                    cart.products[i].qty_purchased++
                    document.getElementById(index).innerHTML=cart.products[i].qty_purchased;
                    cart.itemCount++
                }
                else{
                    $(document).ready(function(){
                        $(".toast").toast({ delay: 3000 });
                        $('.toast').toast('show');
                    }); 
                }
                
            }
            else{ 
                //if item not exist
                if(test[index].qty_available==0){
                    $(document).ready(function(){
                        $(".toast").toast({ delay: 3000 });
                        $('.toast').toast('show');
                    }); 
                }
                else{
                    cart.products.push({
                    ...test[index],
                    qty_purchased:1
                })
                document.getElementById(index).innerHTML=1;
                cart.itemCount++
                }
                
            }
            if(cart.itemCount != '0'){
                document.getElementById('checkoutBtnFab').style.display = 'block';
            } else {
                document.getElementById('checkoutBtnFab').style.display = 'none';
            }
            // console.log(cart)
        }
        const removeProduct = index => {
            const i = cart.products.findIndex( item => item.id === test[index].id)
            if( i === -1 ){
                // console.log('Item not in cart')
                return
            }
            else if (cart.products[i].qty_purchased <= 1){
                cart.products = cart.products.filter( item => item.id != test[index].id)
                document.getElementById(index).innerHTML=0;
            }
            else {
                cart.products[i].qty_purchased--
                document.getElementById(index).innerHTML=cart.products[i].qty_purchased;
            }
            cart.itemCount--
            // console.log(cart)
            if(cart.itemCount != '0'){
                document.getElementById('checkoutBtnFab').style.display = 'block';
            } else {
                document.getElementById('checkoutBtnFab').style.display = 'none';
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            display: none;
        }

        .fab-button {
            z-index: 2;
            margin-top: 40px;
            position: fixed;
            right: 50px;
            bottom: 50px;
            border-radius: 100px;
            box-shadow: 2px 2px 10px -2px rgba(0,0,0,0.75);
        }
    </style>
</head>

<body onload="setPage()">
    <div class="btn btn-success fab-button px-3 py-2" style="display: none;" id="checkoutBtnFab" onclick="gotoCart()">  
        <p class="pr-1" style="display: inline; vertical-align: middle;"><span style="display: inline;" class="d-none d-sm-none d-md-none d-lg-inline">CHECKOUT</span></p>
        <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-cart3" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .49.598l-1 5a.5.5 0 0 1-.465.401l-9.397.472L4.415 11H13a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l.84 4.479 9.144-.459L13.89 4H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
        </svg>
    </div>
    <header>
        <%- include ("partials/header.ejs") %>
    </header>
    <br />
    <div style="width: 250px;" class="mx-auto p-3">
    <center><img src="/images/logo.png" 
                         alt="mushroom" class="thumbnail" 
                         style="border-radius: 50px;"></center>
                        </div>
    <div class="container-fluid">
        <h3 style="text-align: center;">Our Tasty & Healty Mushrooms</h3>
        <hr>
        <div class="row">
            <% products.forEach((product,index) => { %>
                <div style="width: 330px;" class="mx-auto p-3">
                    <img src="<%= product.image_url %>" 
                         alt="mushroom" class="thumbnail" 
                         style="border-top-left-radius: 10px; border-top-right-radius: 10px;">
                    <div class="box-element product card-img-top mb-4" style="border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
                        <div>
                            <h5 style="display: inline; vertical-align: middle;">
                                <b><%= product.item_name %></b><hr>
                                <h6 ><strong>&#8377;<%= product.price%>/packet(250g)</strong></h6>
                            </h5>
                           
                        </div>
                        <hr>
                        <p style="text-align: justify; min-height: 70px; max-height: 100px;"><%= product.item_description %></p>
                        <h5 class="mb-3"><b>Available: <%= product.qty_available %></b></h5>
                        <center>
                            <div class="btn-group" role="group" aria-label="Basic example">
                                <button data-product=1 data-action="add" type="button" 
                                        class="btn btn-secondary add-btn update-cart"
                                        onclick="addProduct('<%- index %>')"
                                        style="border-top-left-radius: 7px; border-bottom-left-radius: 7px;">+</button>
                                <span id = '<%- index %>' class="btn btn-secondary">0</span>
                                <button data-product=1 data-action="remove" type="button" 
                                        class="btn btn-secondary add-btn update-cart"
                                        onclick="removeProduct('<%- index %>')"
                                        style="border-top-right-radius: 7px; border-bottom-right-radius: 7px;">-</button>
                            </div>
                        </center>
                    </div>
                </div>
            <% })%>
        </div>
        <!-- <br>
        <br>
        <hr size="20 "> -->

        <!-- <center><span class="btn"><a onclick="gotoCart()"><i class="fa fa-2x fa-shopping-cart " aria-hidden="true"></i><h3>&nbsp;Proceed To Cart</h3></a></span></center> -->
    </div>
    <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center text-light" style="min-height: 200px;position:fixed; top: 25px; right: 50px;">
        <div class="toast bg-dark" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="true">
          <div class="toast-header bg-light">
            <strong class="mr-auto">Message</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="toast-body">
            Item not in stock anymore!
          </div>
        </div>
      </div>
    <footer>
        <%- include ("partials/footer.ejs") %>
    </footer>
</body>

</html>